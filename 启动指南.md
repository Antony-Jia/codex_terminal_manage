# Codex Terminal Manager 启动指南

## 问题诊断

之前遇到的问题是：**多个后端实例同时运行**，导致端口冲突和请求路由混乱。

### 问题表现
- 前端发起请求到 `http://127.0.0.1:8000/profiles`
- 后端没有收到请求或请求超时
- netstat显示多个进程监听8000端口
- 大量CLOSE_WAIT状态的TCP连接

### 根本原因
1. 多次启动后端服务，导致多个Python进程监听同一端口
2. Windows上的端口复用机制允许多个进程绑定同一端口
3. 请求被路由到错误的后端实例

## 解决方案

### 1. 清理旧进程

```powershell
# 查找占用8000端口的进程
netstat -ano | findstr :8000 | findstr LISTENING

# 停止所有占用8000端口的进程
# 将下面的PID替换为实际的进程ID
Stop-Process -Id <PID1>,<PID2>,<PID3> -Force
```

### 2. 正确启动服务

#### 后端启动（在 terminal_manage 环境中）

```powershell
# 方法1: 如果已经激活了 terminal_manage 环境
cd backend
poetry run uvicorn app.main:app --host 127.0.0.1 --port 8000 --reload

# 方法2: 使用 conda run
cd backend
conda run -n terminal_manage poetry run uvicorn app.main:app --host 127.0.0.1 --port 8000 --reload
```

#### 前端启动

```powershell
cd frontend
npm run dev
# 或
pnpm dev
```

### 3. 验证服务状态

```powershell
# 检查端口监听状态
netstat -ano | findstr :8000
netstat -ano | findstr :5173

# 测试后端API
Invoke-WebRequest -Uri http://127.0.0.1:8000/health -UseBasicParsing
Invoke-WebRequest -Uri http://127.0.0.1:8000/profiles -UseBasicParsing

# 或使用测试脚本
.\test_api.ps1
```

## 快速启动脚本

### 停止并重启后端

使用提供的 PowerShell 脚本：

```powershell
.\restart_backend.ps1
```

### 测试API

```powershell
.\test_api.ps1
```

## 常见问题

### Q: 为什么会有多个进程监听同一端口？
A: Windows的端口复用机制允许这种情况。确保每次只启动一个后端实例。

### Q: 如何确认后端正在正确运行？
A: 访问 http://127.0.0.1:8000/health 应该返回 `{"status":"ok"}`

### Q: 前端请求超时怎么办？
A: 
1. 检查后端是否正在运行
2. 检查是否有多个后端实例
3. 清理旧进程并重新启动

### Q: CORS错误怎么办？
A: 后端已配置允许所有来源，如果仍有问题，检查：
- 后端是否正确启动
- CORS中间件配置是否正确
- 浏览器控制台的具体错误信息

## 端口使用

- 后端: `http://127.0.0.1:8000`
- 前端: `http://127.0.0.1:5173` (Vite开发服务器)

## 注意事项

1. **确保只启动一个后端实例**
2. 使用 `terminal_manage` conda环境运行后端
3. 如果遇到端口占用，先停止所有旧进程
4. uvicorn的 `--reload` 选项会自动重新加载代码更改
